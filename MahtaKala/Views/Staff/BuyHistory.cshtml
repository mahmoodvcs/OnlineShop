@{
    ViewData["Title"] = ViewData["Title"];
    Layout = "~/Views/Shared/_Staff.cshtml";
}
@(Html.Kendo().Grid<MahtaKala.Models.BuyHistoryModel>().Name("grid").Columns(columns =>
{
    columns.Bound(p => p.Customer).Title("مشتری");
    columns.Bound(p => p.CheckoutDate).Title("تاریخ سفارش");
    columns.Bound(p => p.State).Title("وضعیت");
    columns.Bound(p => p.ApproximateDeliveryDate).Title("تاریخ تقریبی تحویل");
    columns.Bound(p => p.SendDate).Title("تاریخ ارسال");
    columns.Bound(p => p.ActualDeliveryDate).Title("تاریخ تحویل");
    columns.Bound(p => p.Price).Title("قیمت");
    columns.Command(command => command.Custom("تایید ارسال").Click("ConfirmSent")).Width(90);
    columns.Command(command => command.Custom("تایید تحویل").Click("ConfirmDelivered")).Width(90);

})
                                 .Pageable(pageable => pageable
        .Refresh(true)
        .PageSizes(true)
        .ButtonCount(5)).Filterable().Sortable().DataSource(dataSource => dataSource
                .Ajax()
                .PageSize(50)
                .Model(model =>
                {
                    model.Id(p => p.Id);

                })
                .Read(read => read.Action("GetBuyHistory", "Staff"))
                                                                                                                                                                                                                                                                                    )
        )
@section js{
    <script type="text/javascript">
        function ConfirmSent(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            Swal.fire({
                title: "دریافت شماره ی پیک",
                text: "شماره ی پیک را وارد نمایید",
                input: 'text',
                showCancelButton: true,
                inputPlaceholder: "شماره ی پیک",
                preConfirm: (value) => {
                    if (value === false || value === "")
                        Swal.showValidationMessage("شماره ی پیک را وارد نمایید")
                },
            }).then((result) => {
                if (result.value) {
                    $.post("@Url.Action("ConfirmSent", "Staff")",
                        {
                            Id: dataItem.Id,
                            delivererId: result.value
                        },
                        function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                ShowError(response.message);
                            }
                        })
                        .fail(function (response) {
                            ShowError(response.responseText);
                        });
                }
            });
        }

        function ConfirmDelivered(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            Swal.fire({
                title: "دریافت شماره ی پیگیری",
                text: "شماره ی پیگیری را وارد نمایید",
                input: 'text',
                showCancelButton: true,
                inputPlaceholder: "شماره ی پیگیری",
                preConfirm: (value) => {
                    if (value === false || value === "")
                        Swal.showValidationMessage("شماره ی پیگیری را وارد نمایید")
                },
            }).then((result) => {
                if (result.value) {
                    $.post("@Url.Action("ConfirmDelivered", "Staff")",
                        {
                            Id: dataItem.Id,
                            TrackNo: result.value
                        },
                        function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                ShowError(response.message);
                            }
                        })
                        .fail(function (response) {
                            ShowError(response.responseText);
                        });
                }
            });
        }

        function ShowError(message) {

            Swal.fire({
                icon: 'error',
                title: 'خطا',
                text: message
            });
        }

    </script>
}
