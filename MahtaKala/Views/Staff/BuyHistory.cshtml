@{
    ViewData["Title"] = ViewData["Title"];
    Layout = "~/Views/Shared/_Staff.cshtml";
}
@(Html.Kendo().Grid<MahtaKala.Models.BuyHistoryModel>().Name("grid").Columns(columns =>
{
    columns.Bound(p => p.Customer).Title("مشتری");
    columns.Bound(p => p.CheckoutDate).Title("تاریخ سفارش");
    columns.Bound(p => p.SendDate).Title("تاریخ ارسال");
    columns.Bound(p => p.Price).Title("قیمت");
    columns.Bound(p => p.State).Title("وضعیت");
    columns.Command(command => command.Custom("تایید ارسال").Click("ConfirmSent")).Width(90);
    columns.Command(command => command.Custom("تایید تحویل").Click("ConfirmDelivered")).Width(90);

})
                                 .Pageable(pageable => pageable
        .Refresh(true)
        .PageSizes(true)
        .ButtonCount(5)).Filterable().Sortable().DataSource(dataSource => dataSource
                .Ajax()
                .PageSize(50)
                .Model(model =>
                {
                    model.Id(p => p.Id);

                })
                .Read(read => read.Action("GetBuyHistory", "Staff"))
                                                                                                                                                                                                                                                                                    )
        )
@section js{
    <script type="text/javascript">
        function ConfirmSent(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            swal({
                title: "دریافت شماره ی پیک",
                text: "شماره ی پیک را وارد نمایید",
                type: "input",
                showCancelButton: true,
                closeOnConfirm: false,
                animation: "slide-from-top",
                inputPlaceholder: "شماره ی پیک"
            },
                function (inputValue) {
                    if (inputValue === false) return false;

                    if (inputValue === "") {
                        swal.showInputError("شماره ی پیک را وارد نمایید");
                        return false
                    }

                    $.post("@Url.Action("ConfirmSent", "Staff")",
                        {
                            Id: dataItem.Id,
                            delivererId: inputValue
                        },
                        function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'خطا',
                                    text: response.message
                                });
                            }
                        });
                });
        }

        function ConfirmDelivered(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            swal({
                title: "دریافت شماره پیگیری",
                text: "شماره پیگیری را وارد نمایید",
                type: "input",
                showCancelButton: true,
                closeOnConfirm: false,
                animation: "slide-from-top",
                inputPlaceholder: "شماره پیگیری"
            },
                function (inputValue) {
                    if (inputValue === false) return false;

                    if (inputValue === "") {
                        swal.showInputError("شماره پیگیری را وارد نمایید");
                        return false
                    }

                    $.post("@Url.Action("ConfirmDelivered", "Staff")",
                        {
                            Id: dataItem.Id,
                            TrackNo: inputValue
                        },
                        function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'خطا',
                                    text: response.message
                                });
                            }
                        });
                });
            ConfirmServer(e, "@Url.Action("ConfirmDelivered", "Staff")", dataItem.Id);
        }

        function ConfirmServer(e, url, Id) {

            $.post(url,
                {
                    Id: Id
                },
                function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطا',
                            text: response.message
                        });
                    }
                });
        }
    </script>
}
